<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        html, body {
            height: 100%;
            margin: 0;
        }
        #overlays-menu {
            background: #fff;
            position: absolute;
            z-index: 1;
            top: 10px;
            right: 10px;
            border-radius: 3px;
            width: 180px;
            border: 1px solid rgba(0, 0, 0, 0.4);
            font-family: 'Open Sans', sans-serif;
        }

        #overlays-menu a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.25);
            text-align: left;
        }
        #overlays-menu a .overlay-preview-icon {
            float: left;
            border-style: solid;
            border-width: 1px;
            border-color: #5554;
            margin-right: 0.5em;
        }
        #overlays-menu a:last-child {
            border: none;
        }
        #overlays-menu a:hover {
            background-color: #f8f8f8;
            color: #404040;
        }
        #overlays-menu a.active {
            background-color: #3887be;
            color: #ffffff;
        }
        #overlays-menu a.active:hover {
            background: #3074a4;
        }
        </style>
</head>
<body>

<nav id="overlays-menu"></nav>
<div id="map" style="width: 100%; height: 100%;"></div>
<script>

    overlayLayersConfig = {
        bikeLanes: {
            'name':               'OSM Bike Lanes',
            'data-url':           'layers/current_bike_infrastructure.geojson',
            'type':               'line',
            'default-visibility': 'visible',
            'attribution':        'OSM Bike Lanes &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            'line-color':         '#22f',
            'line-width':         3,
        },
        campaigns: {
            'name':               'BikeSD Campaigns',
            'data-url':           'layers/campaigns.geojson',
            'type':               'line',
            'default-visibility': 'visible',
            'attribution':        '',
            'line-color':         '#282',
            'line-width':         6,
            'line-dasharray':     [3, 2],
            'line-join': 'bevel',
            'line-cap': 'square',
        },
        sexyStreets: {
            'name':               'SD "Sexy Streets"',
            'data-url':           'layers/sexy_streets.geojson',
            'type':               'line',
            'default-visibility': 'none',
            'attribution':        'Sexy Streets &copy; Jacob Mandel and SANDAG',
            'line-color':         '#d10069',
            'line-width':         2,
        },
        schools: {
            'name':               'Schools',
            'data-url':           'layers/schools.geojson',
            'marker-url':         'icons/college.png',
            'type':               'symbol',
            'default-visibility': 'none',
            'attribution':        'Schools &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            'icon-image':         'school-marker',
            'text-field':         [
                "step", ["zoom"],
                '',                 // from zoom levels 0-12, no label
                13, ['get', 'name'] // at zoom level 13+, show a label based on the name attribute!
            ],
        },
        crashes: {
            'name':               'Crashes (2011-2020)',
            'data-url':           'layers/crashes.geojson',
            'type':               'heatmap',
            'pivot-zoom':         14,
            'default-visibility': 'none',
            'attribution':        'Crashes &copy; TIMS/UC Berkeley',
            // assign color values be applied to points depending on their density
            'heatmap-color': [
                'interpolate', ['linear'],
                ['heatmap-density'], // interpolation input value
                0,   'rgba(180, 180, 0, 0)',
                0.2, 'rgba(180, 180, 0, 1)',
                1.0, 'rgba(180,   0, 0, 1)',
            ],
            'circle-radius': 10,
            'circle-color': {
                property: 'COLLISION_SEVERITY',
                type: 'categorical',
                stops: [
                    [1, '#f00'], // red: collision severity 1 (killed)
                    [2, '#f70'], // reddish: collision severity 2 (severe injury)
                    [3, '#fb0'], // yellowish: collision severity 1 (injury)
                    [4, '#ff0'], // yellow: collision severity 1 (complaint of pain)
                ]
            },
            // increase weight as diameter breast height increases
            'heatmap-weight': [
                'interpolate', ['linear'],
                ['to-number', ['get', 'COLLISION_SEVERITY']], // interpolation input value
                1, 1.0, // at collision severity 1 (someone killed), the weight at the maximum.
                // between severity 4-1, linearly interpolate the weight.
                4, 0.3, // at collision severity 4 (minor injury), the weight is low, at only 0.3.
            ],
        },
    }

    overlayRenderOrder = [
        'crashes',
        'bikeLanes',
        'sexyStreets',
        'campaigns',
    ]

    function trySortOverlays() {
        //
        // Sort all the layers of the overlays based on the predetermined overlayRenderOrder.
        //

        readyToSort = overlayRenderOrder.every(
            overlayId => overlayLayersConfig[overlayId].hasOwnProperty('added-layer-ids')
        );
        // Only attempt sorting once all the layers have been added to the map.
        if (!readyToSort) {
            return;
        }
        // Find the index of the first symbol layer in the map style.  This
        // helps us later add data layers beneath the map symbols like street
        // names and neighborhood names.
        let firstSymbolId;
        for (const layer of map.getStyle().layers) {
            if (layer.type === 'symbol') {
                firstSymbolId = layer.id;
                break;
            }
        }
        // Make a list of ordered layers from the ordered overlays.  By now, we should be complete adding all the
        // layers, so all the overlay configs should have layer IDs filled in.
        layerRenderOrder = overlayRenderOrder.map(
            overlayId => overlayLayersConfig[overlayId]['added-layer-ids']
        ).flat()
        // Append the first symbol id to give us an anchor.  All the layers we're dealing with in this function should
        // be non-text layers.
        layerRenderOrder.push(firstSymbolId);
        // Finally, iterate the layer render order in reverse because moveLayer() only supports adding behind a
        // specified layer.
        for (let i = layerRenderOrder.length - 2; i >= 0; i--) {
            map.moveLayer(layerRenderOrder[i], layerRenderOrder[i+1]);
        }
    }

    function toggleOverlayVisibility(linkElement) {
        //
        // One of the overlay links was clicked, so toggle the both the visibility of that overlay
        // and the link itself.
        //
        // Args:
        //   - linkElement: The link element clicked.

        const overlayConfig = overlayLayersConfig[linkElement.id]
        const currentVisibility = map.getLayoutProperty(overlayConfig['added-layer-ids'][0], 'visibility') ?? 'visible';

        // Toggle layer visibility by changing the layout object's visibility property.
        if (currentVisibility === 'visible') {
            linkElement.className = '';
            overlayConfig['added-layer-ids'].forEach(
                (layerId) => map.setLayoutProperty(layerId, 'visibility', 'none')
            );
        } else {
            linkElement.className = 'active';
            overlayConfig['added-layer-ids'].forEach(
                (layerId) => map.setLayoutProperty(layerId, 'visibility', 'visible')
            );
        }

    }

    function makeOverlayPreviewIcon(overlayConfig) {
        //
        // Return an SVG element which contains an icon which visually represents the given overlay.
        //
        // Args:
        //   - overlayConfig (object): configuration for a map overlay.
        //
        // Returns:
        //   An SVG DOM element which can be appended to anything.

        let width_px = 25;
        let height_px = 16;

        // first, make the overall SVG object.
        let previewSVG = document.createElementNS("http://www.w3.org/2000/svg", 'svg');
        previewSVG.setAttribute('width', width_px);
        previewSVG.setAttribute('height', height_px);
        previewSVG.setAttribute('viewBox', [0, 0, width_px, height_px].join(""));
        previewSVG.setAttribute('class', 'overlay-preview-icon');

        // then, add a background which is opaque white.
        let previewBackgroundRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        previewBackgroundRect.setAttribute('x', '0%');
        previewBackgroundRect.setAttribute('y', '0%');
        previewBackgroundRect.setAttribute('width', '100%');
        previewBackgroundRect.setAttribute('height', '100%');
        previewBackgroundRect.setAttribute('fill', '#fff');
        previewSVG.appendChild(previewBackgroundRect);

        // finally, draw a sample line similar in appearance to the actual overlay lines.
        let previewLineRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        previewLineRect.setAttribute("y", height_px / 2 - overlayConfig['line-width'] / 2);
        previewLineRect.setAttribute("width", "100%");
        previewLineRect.setAttribute("height", overlayConfig['line-width']);
        previewLineRect.setAttribute("fill", overlayConfig['line-color']);
        previewSVG.appendChild(previewLineRect);
        return previewSVG;
    }

    // Set up the corresponding toggle button for each overlay.
    for (const overlayId in overlayLayersConfig) {
        const overlayConfig = overlayLayersConfig[overlayId];

        const linkElement = document.createElement('a');
        linkElement.id = overlayId;
        linkElement.href = '#';

        // Create and add a preview icon of the current overlay.  This only gets added for supported
        // overlay types which we actually know how to draw previews for, currently just lines.
        if (overlayConfig['type'] === 'line') {
            linkElement.appendChild(makeOverlayPreviewIcon(overlayConfig));
        }

        // Make the link text the pretty name of the overlay.
        const layerNameElement = document.createElement('span');
        layerNameElement.textContent = overlayConfig['name'];
        linkElement.appendChild(layerNameElement);

        linkElement.className = (overlayConfig['default-visibility'] ?? 'visible') == 'visible' ? 'active' : '';

        // Show or hide layer when the toggle is clicked.
        linkElement.onclick = function (e) {
            e.preventDefault();
            e.stopPropagation();
            toggleOverlayVisibility(this);
        };

        // Add the new overlay toggle button to the menu.
        document.getElementById('overlays-menu').appendChild(linkElement);
    }

    // Create the overall map element
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2Fua2V5dG0iLCJhIjoiY2t6NW9uZjJtMHNodDJ2cDRtdWVjZmxpeSJ9.m6UectzjMjF_vZo2SquLeQ';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10',
        // center and zoom into San Diego
        center: [-117.1517, 32.7552],
        zoom: 11,
    });

    // Disable map rotation using touch rotation gesture.  I have found that while using this app on
    // a phone, it is way too prone to accidental rotation.
    map.touchZoomRotate.disableRotation();

    // Once the map is loaded, fetch and load all the data for the layers and add them to the map.
    map.on('load', () => {
        // Find the index of the first symbol layer in the map style.  This
        // helps us later add data layers beneath the map symbols like street
        // names and neighborhood names.
        let firstSymbolId;
        for (const layer of map.getStyle().layers) {
            if (layer.type === 'symbol') {
                firstSymbolId = layer.id;
                break;
            }
        }
        // Start to loop over each overlay layer and fetch the data and add it to the map.
        for (const overlayId in overlayLayersConfig) {
            const overlayConfig = overlayLayersConfig[overlayId]

            // use jQuery to fetch the geojson data for the current overlay layer.
            $.getJSON(overlayConfig['data-url'], function(data) {

                // Given the downloaded geojson data, add it to a new Mapbox "source" so that it can later be used by a layer.
                map.addSource(overlayId, {
                    'type': 'geojson',
                    'data': data,
                    'attribution': overlayConfig.attribution,
                });

                // Right now the only two supported data types are lines (ways) or symbols (nodes).
                if (overlayConfig.type === 'line') {
                    map.addLayer({
                        'id': overlayId,
                        'type': 'line',
                        'source': overlayId,
                        'layout': {
                            'line-join': overlayConfig['line-join'] || 'round',
                            'line-cap': overlayConfig['line-cap'] || 'round',
                            'visibility': overlayConfig['default-visibility'],
                        },
                        'paint': {
                            'line-color': overlayConfig['line-color'],
                            'line-width': overlayConfig['line-width'],
                        }
                    }, firstSymbolId);

                    if (overlayConfig.hasOwnProperty('line-dasharray')) {
                        map.setPaintProperty(overlayId, 'line-dasharray', overlayConfig['line-dasharray']);
                    }

                    // Update the overlay configs to signal to other overlays that they can add behind.
                    overlayConfig['added-layer-ids'] = [overlayId]
                } else if (overlayConfig.type === 'symbol') {
                    map.loadImage(
                        overlayConfig['marker-url'],
                        (error, image) => {
                            if (error) throw error;
                            map.addImage(overlayId + '-marker', image);
                            overlayConfig['added-layer-ids'] = [overlayId]
                            map.addLayer({
                                'id': overlayId,
                                'type': 'symbol',
                                'source': overlayId,
                                'layout': {
                                    'icon-image': overlayId + '-marker',
                                    'text-field': ["step", ["zoom"],
                                        '',                 // from zoom levels 0-12, no label
                                        13, ['get', 'name'] // at zoom level 13+, show a label!
                                    ],
                                    'text-font': [
                                        'Open Sans Semibold',
                                        'Arial Unicode MS Bold'
                                    ],
                                    'text-offset': [0, 1.25],
                                    'text-anchor': 'top',
                                    'visibility': overlayConfig['default-visibility'],
                                }
                            });
                        }
                    );
                } else if (overlayConfig.type === 'heatmap') {
                    // We're going to make a custom heatmap overlay which is actually both a Mapbox GL "heatmap" AND a
                    // Mapbox GL "circle" layer at the same time.  The heatmap layer will appear at lower zoom levels,
                    // while the circle layer will appear at higher zoom levels.
                    map.addLayer({
                        'id': overlayId + '-heatmap',
                        'type': 'heatmap',
                        'source': overlayId,
                        maxzoom: 15,
                        'layout': {
                            'visibility': overlayConfig['default-visibility'],
                        },
                        'paint': {
                            // assign weight dynamically
                            'heatmap-weight': overlayConfig['heatmap-weight'],
                            // increase intensity as zoom level increases
                            'heatmap-intensity': {
                                stops: [
                                    [9,  0.05],
                                    [11, 0.50],
                                    [15, 1.50],
                                    // >= zoom level 15 the heatmap is completely hidden and points are shown.
                                ]
                            },
                            // assign color values dynamically
                            'heatmap-color': overlayConfig['heatmap-color'],
                            // increase radius as zoom increases
                            'heatmap-radius': {
                                stops: [
                                    [11, 15],
                                    [15, 20]
                                ]
                            },
                            // decrease opacity to transition into the circle layer
                            'heatmap-opacity': {
                                default: 1,
                                stops: [
                                    [14, 1],
                                    [15, 0]
                                ]
                            }
                        }
                    }, firstSymbolId);

                    // Point layer shows up after zooming in far enough.
                    map.addLayer({
                        'id': overlayId + '-points',
                        type: 'circle',
                        source: overlayId,
                        minzoom: 14,
                        'layout': {
                            'visibility': overlayConfig['default-visibility'],
                        },
                        paint: {
                            'circle-radius': overlayConfig['circle-radius'],
                            'circle-color': overlayConfig['circle-color'],
                            'circle-stroke-color': 'black',
                            'circle-stroke-width': 1,
                            'circle-opacity': {
                                stops: [
                                    // The circles only begin to appear at zoom level 14 which is
                                    // when the heatmap begins to fade away.
                                    [14, 0],
                                    // At zoom level 15, the heatmap has completely disappeared, so
                                    // make the circles completely opaque.
                                    [15, 1],
                                ]
                            }
                        }
                    }, firstSymbolId);

                    // Update the overlay configs to signal to other overlays that they can add behind.
                    overlayConfig['added-layer-ids'] = [overlayId + '-heatmap']
                    overlayConfig['added-layer-ids'].push(overlayId + '-points')
                }
                trySortOverlays();
            });
        }
    });

</script>

</body>
</html>

